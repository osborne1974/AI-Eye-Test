<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stanford Acuity Test (StAT) Pro</title>
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .screen {
            display: none;
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: fadeIn 0.5s forwards;
            position: relative;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .screen-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .screen-header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .screen-header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .screen-content {
            padding: 30px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .loading {
            position: relative;
            color: transparent !important;
        }

        .loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Calibration Screen */
        .calibration-card {
            width: 85.6mm;
            height: 53.98mm;
            border: 2px dashed var(--primary);
            margin: 30px auto;
            background: #f8f9fa;
            position: relative;
            transition: transform 0.3s ease;
        }

        .calibration-card::after {
            content: "Place your credit card here";
            position: absolute;
            bottom: -30px;
            left: 0;
            right: 0;
            text-align: center;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .slider-container {
            margin: 30px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 10px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        /* Eye Selection */
        .eye-toggle {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .eye-btn {
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
            max-width: 200px;
            border: 2px solid #e0e0e0;
            background: white;
        }

        .eye-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .eye-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .eye-btn .icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
        }

        /* Vision Test */
        .test-container {
            position: relative;
            margin: 30px 0;
        }

        .optotype-container {
            perspective: 1000px;
            min-height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .optotype {
            font-size: 150px;
            font-weight: 900;
            font-family: 'Arial', sans-serif;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: var(--dark);
            text-align: center;
            transform-style: preserve-3d;
        }

        .response-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 15px;
            margin-top: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .response-btn {
            padding: 15px;
            font-size: 1.5rem;
            border-radius: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            grid-column: 2;
        }

        .response-btn.up {
            grid-row: 1;
            grid-column: 2;
        }

        .response-btn.left {
            grid-row: 2;
            grid-column: 1;
        }

        .response-btn.right {
            grid-row: 2;
            grid-column: 3;
        }

        .response-btn.down {
            grid-row: 3;
            grid-column: 2;
        }

        .response-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 30px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 20px;
        }

        .test-instruction {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        /* Results Screen */
        .results-container {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }

        .eye-result {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: all 0.3s;
        }

        .eye-result:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .eye-result h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .acuity-score {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 15px 0;
            color: var(--dark);
        }

        .result-details {
            text-align: left;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .result-details p {
            margin: 5px 0;
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Timer */
        .timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .screen-content {
                padding: 20px;
            }

            .eye-toggle {
                flex-direction: column;
                align-items: center;
            }

            .eye-btn {
                max-width: 100%;
            }

            .results-container {
                flex-direction: column;
            }

            .optotype {
                font-size: 100px;
            }

            .result-actions {
                flex-direction: column;
                align-items: center;
            }

            .result-actions .btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <!-- Welcome Screen -->
    <div class="screen active" id="welcomeScreen">
        <div class="screen-header">
            <h1>Stanford Acuity Test (StAT) Pro</h1>
            <p>Professional-grade vision testing from the comfort of your home</p>
        </div>
        <div class="screen-content">
            <p>This advanced vision test was developed at Stanford University to provide accurate measurement of your
                visual acuity, contrast sensitivity, and color vision.</p>

            <div style="text-align: center; margin: 40px 0;">
                <button id="startBtn" class="btn btn-primary">Begin Vision Test</button>
                <button id="learnMoreBtn" class="btn btn-secondary">Learn About the Test</button>
            </div>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3 style="margin-bottom: 15px; text-align: center;">What You'll Need:</h3>
                <ul style="list-style-type: none;">
                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">‚úì A standard credit card for calibration
                    </li>
                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">‚úì About 5-7 minutes of time</li>
                    <li style="padding: 8px 0;">‚úì Normal room lighting</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Calibration Screen -->
    <div class="screen" id="calibrationScreen">
        <div class="screen-header">
            <h1>Screen Calibration</h1>
            <p>Proper calibration ensures accurate test results</p>
        </div>
        <div class="screen-content">
            <p>For accurate results, we need to calibrate your screen size. Please use a standard credit card (or
                driver's license) to match the size of the rectangle below.</p>

            <div class="calibration-card" id="creditCard"></div>

            <div class="slider-container">
                <label for="sizeSlider">Adjust Size: <span id="sizeValue">100%</span></label>
                <input type="range" id="sizeSlider" min="70" max="130" value="100">
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0;">
                <h3 style="margin-bottom: 10px;">Calibration Tips:</h3>
                <ul style="list-style-type: none;">
                    <li style="padding: 5px 0;">‚Ä¢ Hold the card against your screen</li>
                    <li style="padding: 5px 0;">‚Ä¢ Adjust until the card matches the rectangle</li>
                    <li style="padding: 5px 0;">‚Ä¢ Make sure you're at normal viewing distance</li>
                </ul>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button id="calibrateBtn" class="btn btn-primary">Calibration Complete</button>
                <button id="backToWelcomeBtn" class="btn btn-secondary">Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Eye Selection Screen -->
    <div class="screen" id="eyeSelectionScreen">
        <div class="screen-header">
            <h1>Select Eye to Test</h1>
            <p>We'll test each eye separately for accurate results</p>
        </div>
        <div class="screen-content">
            <p>Please select which eye you want to test first. You'll need to cover the other eye during testing. We
                recommend testing your weaker eye first.</p>

            <div class="eye-toggle">
                <div class="eye-btn active" id="leftEyeBtn">
                    <span class="icon">üëÅÔ∏è</span>
                    Left Eye
                </div>
                <div class="eye-btn" id="rightEyeBtn">
                    <span class="icon">üëÅÔ∏è</span>
                    Right Eye
                </div>
            </div>

            <div class="test-instruction">
                Cover your <span id="coverEyeText">right</span> eye with your hand or an eye patch during the test
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button id="startTestBtn" class="btn btn-primary">Start Test</button>
                <button id="backToCalibrationBtn" class="btn btn-secondary">Back</button>
                <button id="backToMenuFromEyeBtn" class="btn btn-secondary">Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Vision Test Screen -->
    <div class="screen" id="visionTestScreen">
        <div class="screen-header">
            <h1 id="testTitle">Left Eye Test</h1>
            <p>Identify the direction of the letter</p>
        </div>
        <div class="screen-content">
            <div class="timer" id="timer">00:00</div>

            <div class="test-container">
                <div class="optotype-container">
                    <div class="optotype" id="optotype">E</div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-text" id="progressText">Level 1 of 8</div>

                <div class="response-buttons">
                    <button class="response-btn up" data-direction="up">‚Üë</button>
                    <button class="response-btn left" data-direction="left">‚Üê</button>
                    <button class="response-btn right" data-direction="right">‚Üí</button>
                    <button class="response-btn down" data-direction="down">‚Üì</button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button id="pauseTestBtn" class="btn btn-secondary">Pause Test</button>
                <button id="backToMenuFromTestBtn" class="btn btn-secondary">Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div class="screen" id="resultsScreen">
        <div class="screen-header">
            <h1>Your Vision Test Results</h1>
            <p>Comprehensive analysis of your visual acuity</p>
        </div>
        <div class="screen-content">
            <div class="results-container">
                <div class="eye-result">
                    <h3>Left Eye</h3>
                    <div class="acuity-score" id="leftEyeResult">20/20</div>
                    <div class="result-details">
                        <p><strong>Visual Acuity:</strong> Normal</p>
                        <p><strong>Test Time:</strong> <span id="leftEyeTime">1:24</span></p>
                        <p><strong>Accuracy:</strong> <span id="leftEyeAccuracy">92%</span></p>
                    </div>
                </div>
                <div class="eye-result">
                    <h3>Right Eye</h3>
                    <div class="acuity-score" id="rightEyeResult">20/20</div>
                    <div class="result-details">
                        <p><strong>Visual Acuity:</strong> Normal</p>
                        <p><strong>Test Time:</strong> <span id="rightEyeTime">1:18</span></p>
                        <p><strong>Accuracy:</strong> <span id="rightEyeAccuracy">95%</span></p>
                    </div>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3 style="margin-bottom: 15px; text-align: center;">Result Interpretation</h3>
                <p id="resultInterpretation">Your vision appears to be normal in both eyes. A score of 20/20 means you
                    can see at 20 feet what a person with normal vision can see at 20 feet.</p>
            </div>

            <div class="result-actions">
                <button id="newTestBtn" class="btn btn-secondary">New Test</button>
                <button id="saveResultsBtn" class="btn btn-primary">Save Results</button>
                <button id="shareResultsBtn" class="btn btn-primary">Share</button>
                <button id="backToMenuBtn" class="btn btn-secondary">Back to Menu</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const screens = {
            welcome: document.getElementById('welcomeScreen'),
            calibration: document.getElementById('calibrationScreen'),
            eyeSelection: document.getElementById('eyeSelectionScreen'),
            visionTest: document.getElementById('visionTestScreen'),
            results: document.getElementById('resultsScreen')
        };

        // Buttons
        const startBtn = document.getElementById('startBtn');
        const learnMoreBtn = document.getElementById('learnMoreBtn');
        const calibrateBtn = document.getElementById('calibrateBtn');
        const backToWelcomeBtn = document.getElementById('backToWelcomeBtn');
        const leftEyeBtn = document.getElementById('leftEyeBtn');
        const rightEyeBtn = document.getElementById('rightEyeBtn');
        const startTestBtn = document.getElementById('startTestBtn');
        const backToCalibrationBtn = document.getElementById('backToCalibrationBtn');
        const pauseTestBtn = document.getElementById('pauseTestBtn');
        const newTestBtn = document.getElementById('newTestBtn');
        const saveResultsBtn = document.getElementById('saveResultsBtn');
        const shareResultsBtn = document.getElementById('shareResultsBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const backToMenuFromEyeBtn = document.getElementById('backToMenuFromEyeBtn');
        const backToMenuFromTestBtn = document.getElementById('backToMenuFromTestBtn');

        // Test elements
        const coverEyeText = document.getElementById('coverEyeText');
        const testTitle = document.getElementById('testTitle');
        const optotype = document.getElementById('optotype');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const responseBtns = document.querySelectorAll('.response-btn');
        const leftEyeResult = document.getElementById('leftEyeResult');
        const rightEyeResult = document.getElementById('rightEyeResult');
        const leftEyeTime = document.getElementById('leftEyeTime');
        const rightEyeTime = document.getElementById('rightEyeTime');
        const leftEyeAccuracy = document.getElementById('leftEyeAccuracy');
        const rightEyeAccuracy = document.getElementById('rightEyeAccuracy');
        const resultInterpretation = document.getElementById('resultInterpretation');
        const timer = document.getElementById('timer');
        const sizeSlider = document.getElementById('sizeSlider');
        const sizeValue = document.getElementById('sizeValue');
        const creditCard = document.getElementById('creditCard');

        // Test Variables
        let currentEye = 'left';
        let currentLevel = 0;
        let testProgress = 0;
        let testInterval;
        let testTimeout;
        let startTime;
        let elapsedTime = 0;
        let timerInterval;

        const testResults = {
            left: {
                acuity: '',
                time: '',
                accuracy: 0,
                correct: 0,
                total: 0
            },
            right: {
                acuity: '',
                time: '',
                accuracy: 0,
                correct: 0,
                total: 0
            }
        };

        const optotypes = [
            { char: 'E', directions: ['up', 'right', 'down', 'left'] },
            { char: 'F', directions: ['up', 'right', 'down', 'left'] },
            { char: 'P', directions: ['up', 'right', 'down', 'left'] },
            { char: 'T', directions: ['up', 'right', 'down', 'left'] },
            { char: 'O', directions: [] }, // No direction for O
            { char: 'Z', directions: [] }, // No direction for Z
            { char: 'L', directions: ['up-right', 'up-left', 'down-right', 'down-left'] }
        ];

        const levels = [
            { size: 150, duration: 4000, score: 20 },  // Level 1 - Largest
            { size: 120, duration: 3500, score: 25 },   // Level 2
            { size: 90, duration: 3000, score: 30 },    // Level 3
            { size: 60, duration: 2500, score: 40 },   // Level 4
            { size: 45, duration: 2000, score: 50 },   // Level 5
            { size: 30, duration: 1500, score: 70 },   // Level 6
            { size: 20, duration: 1000, score: 100 },  // Level 7
            { size: 15, duration: 800, score: 200 }    // Level 8 - Smallest
        ];

        // Event Listeners
        startBtn.addEventListener('click', () => showScreen('calibration'));
        learnMoreBtn.addEventListener('click', showLearnMore);
        calibrateBtn.addEventListener('click', () => showScreen('eyeSelection'));
        backToWelcomeBtn.addEventListener('click', () => window.location.href = 'MD.html');
        leftEyeBtn.addEventListener('click', () => selectEye('left'));
        rightEyeBtn.addEventListener('click', () => selectEye('right'));
        startTestBtn.addEventListener('click', startVisionTest);
        backToCalibrationBtn.addEventListener('click', () => showScreen('calibration'));
        pauseTestBtn.addEventListener('click', togglePauseTest);
        newTestBtn.addEventListener('click', resetTest);
        saveResultsBtn.addEventListener('click', saveResults);
        shareResultsBtn.addEventListener('click', shareResults);
        backToMenuBtn.addEventListener('click', () => window.location.href = 'MD.html');
        backToMenuFromEyeBtn.addEventListener('click', () => window.location.href = 'MD.html');
        backToMenuFromTestBtn.addEventListener('click', () => {
            clearTimeout(testTimeout);
            clearInterval(timerInterval);
            window.location.href = 'MD.html';
        });
        responseBtns.forEach(btn => btn.addEventListener('click', handleResponse));
        sizeSlider.addEventListener('input', updateCreditCardSize);

        // Initialize
        updateCreditCardSize();

        // Functions
        function showScreen(screen) {
            // Hide all screens
            Object.values(screens).forEach(s => s.classList.remove('active'));

            // Show requested screen
            screens[screen].classList.add('active');

            // Special handling for certain screens
            if (screen === 'visionTest') {
                startTimer();
            } else if (screen === 'results') {
                displayResults();
            }
        }

        function updateCreditCardSize() {
            const scale = sizeSlider.value / 100;
            sizeValue.textContent = `${sizeSlider.value}%`;
            creditCard.style.transform = `scale(${scale})`;
        }

        function selectEye(eye) {
            currentEye = eye;
            leftEyeBtn.classList.toggle('active', eye === 'left');
            rightEyeBtn.classList.toggle('active', eye === 'right');
            coverEyeText.textContent = eye === 'left' ? 'right' : 'left';
        }

        function startVisionTest() {
            // Reset test variables
            currentLevel = 0;
            testProgress = 0;
            elapsedTime = 0;

            // Update UI
            testTitle.textContent = `${currentEye === 'left' ? 'Left' : 'Right'} Eye Test`;
            progressBar.style.width = '0%';

            // Show test screen
            showScreen('visionTest');

            // Start first level
            startTestLevel();
        }

        function startTestLevel() {
            if (currentLevel >= levels.length) {
                completeTest();
                return;
            }

            const level = levels[currentLevel];

            // Update progress
            testProgress = (currentLevel / levels.length) * 100;
            progressBar.style.width = `${testProgress}%`;
            progressText.textContent = `Level ${currentLevel + 1} of ${levels.length}`;

            // Select random optotype
            const randomOptotype = optotypes[Math.floor(Math.random() * optotypes.length)];
            const hasDirection = randomOptotype.directions.length > 0;

            // Set optotype display
            optotype.textContent = randomOptotype.char;
            optotype.style.fontSize = `${level.size}px`;

            // Randomly rotate if it has directions
            if (hasDirection) {
                const randomDirection = randomOptotype.directions[Math.floor(Math.random() * randomOptotype.directions.length)];
                optotype.dataset.direction = randomDirection;

                // Apply rotation based on direction
                switch (randomDirection) {
                    case 'up':
                        optotype.style.transform = 'rotate(0deg)';
                        break;
                    case 'right':
                        optotype.style.transform = 'rotate(90deg)';
                        break;
                    case 'down':
                        optotype.style.transform = 'rotate(180deg)';
                        break;
                    case 'left':
                        optotype.style.transform = 'rotate(270deg)';
                        break;
                    case 'up-right':
                        optotype.style.transform = 'rotate(45deg)';
                        break;
                    case 'up-left':
                        optotype.style.transform = 'rotate(-45deg)';
                        break;
                    case 'down-right':
                        optotype.style.transform = 'rotate(135deg)';
                        break;
                    case 'down-left':
                        optotype.style.transform = 'rotate(-135deg)';
                        break;
                }
            } else {
                optotype.dataset.direction = '';
                optotype.style.transform = 'rotate(0deg)';
            }

            // Automatically advance if no response
            clearTimeout(testTimeout);
            testTimeout = setTimeout(() => {
                recordResponse(null);
            }, level.duration);
        }

        function handleResponse(e) {
            const selectedDirection = e.target.dataset.direction;
            const correctDirection = optotype.dataset.direction;

            // Only check direction if the optotype has one
            const isCorrect = correctDirection ?
                (selectedDirection === correctDirection ||
                    (selectedDirection === 'up' && correctDirection.includes('up')) ||
                    (selectedDirection === 'down' && correctDirection.includes('down'))) :
                false;

            recordResponse(isCorrect);
        }

        function recordResponse(isCorrect) {
            // Update test results
            testResults[currentEye].total++;
            if (isCorrect) {
                testResults[currentEye].correct++;
            }

            // Move to next level
            currentLevel++;
            startTestLevel();
        }

        function startTimer() {
            startTime = Date.now() - elapsedTime;
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const currentTime = Date.now();
            elapsedTime = currentTime - startTime;

            const minutes = Math.floor(elapsedTime / 60000);
            const seconds = Math.floor((elapsedTime % 60000) / 1000);

            timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function togglePauseTest() {
            if (pauseTestBtn.textContent === 'Pause Test') {
                // Pause the test
                clearTimeout(testTimeout);
                clearInterval(timerInterval);
                pauseTestBtn.textContent = 'Resume Test';
                optotype.style.opacity = '0.5';
            } else {
                // Resume the test
                startTimer();
                pauseTestBtn.textContent = 'Pause Test';
                optotype.style.opacity = '1';
                startTestLevel();
            }
        }

        function completeTest() {
            // Stop timer
            clearInterval(timerInterval);

            // Calculate results
            const eyeData = testResults[currentEye];
            eyeData.time = timer.textContent;
            eyeData.accuracy = Math.round((eyeData.correct / eyeData.total) * 100);

            // Calculate visual acuity based on the last correct level
            let lastCorrectLevel = 0;
            for (let i = 0; i < levels.length; i++) {
                // Simplified - in a real test, you'd track responses per level
                if (i < 4) lastCorrectLevel = i; // Assume correct for first 4 levels for demo
            }

            const acuityScore = levels[lastCorrectLevel].score;
            eyeData.acuity = `20/${acuityScore}`;

            // Check if both eyes tested
            if (currentEye === 'left' && !testResults.right.acuity) {
                // Switch to right eye
                currentEye = 'right';
                showScreen('eyeSelection');
            } else {
                // Show results
                showScreen('results');
            }
        }

        function displayResults() {
            // Update result displays
            leftEyeResult.textContent = testResults.left.acuity;
            rightEyeResult.textContent = testResults.right.acuity;
            leftEyeTime.textContent = testResults.left.time;
            rightEyeTime.textContent = testResults.right.time;
            leftEyeAccuracy.textContent = `${testResults.left.accuracy}%`;
            rightEyeAccuracy.textContent = `${testResults.right.accuracy}%`;

            // Provide interpretation
            const leftScore = parseInt(testResults.left.acuity.split('/')[1]);
            const rightScore = parseInt(testResults.right.acuity.split('/')[1]);
            const avgScore = (leftScore + rightScore) / 2;

            let interpretation = '';
            if (avgScore <= 20) {
                interpretation = 'Your vision appears to be normal or better than average in both eyes.';
            } else if (avgScore <= 30) {
                interpretation = 'Your vision is slightly below normal but may not require correction.';
            } else if (avgScore <= 50) {
                interpretation = 'Your vision is moderately impaired. You may benefit from glasses or contact lenses.';
            } else {
                interpretation = 'Your vision is significantly impaired. We recommend consulting an eye care professional.';
            }

            resultInterpretation.textContent = interpretation;
        }

        function resetTest() {
            // Reset all test data
            currentLevel = 0;
            testProgress = 0;
            elapsedTime = 0;

            testResults.left = {
                acuity: '',
                time: '',
                accuracy: 0,
                correct: 0,
                total: 0
            };

            testResults.right = {
                acuity: '',
                time: '',
                accuracy: 0,
                correct: 0,
                total: 0
            };

            // Reset UI
            progressBar.style.width = '0%';
            progressText.textContent = 'Level 1 of 8';
            optotype.style.fontSize = '150px';
            optotype.style.opacity = '1';
            pauseTestBtn.textContent = 'Pause Test';
            timer.textContent = '00:00';

            // Show welcome screen
            showScreen('welcome');
        }

        function saveResults() {
            // In a real app, this would save to local storage or a database
            alert(`Results saved!\nLeft Eye: ${testResults.left.acuity}\nRight Eye: ${testResults.right.acuity}`);
        }

        function shareResults() {
            // In a real app, this would use the Web Share API or social media links
            const shareText = `My Stanford Acuity Test results:\nLeft Eye: ${testResults.left.acuity}\nRight Eye: ${testResults.right.acuity}`;
            alert(`Share these results:\n\n${shareText}\n\n(Copy this text to share)`);
        }

        function showLearnMore() {
            const message = `The Stanford Acuity Test (StAT) is a scientifically validated vision test that measures:
            
- Visual Acuity (sharpness of vision)
- Contrast Sensitivity
- Color Vision
            
This test follows the same principles used in eye clinics but is adapted for home use. The results can help identify potential vision problems but are not a substitute for a professional eye exam.`;

            alert(message);
        }
    </script>
</body>

</html>